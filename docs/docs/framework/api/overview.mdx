---
title: API routing overview
description: How the platform discovers and dispatches REST endpoints per module.
---

Open Mercato exposes REST endpoints by discovering files under `src/modules/<module>/api/<method>/<path>.ts` (or their package equivalents). Each file exports a default handler and optional metadata.

## Discovery & routing

- Routes are indexed by `method + path` during `npm run modules:prepare` and stored in `modules.generated.ts`.
- The global dispatcher lives in `src/app/api/[...slug]/route.ts`. It normalises the request path, looks up the handler, and instantiates a request container.
- Metadata controls authentication and authorisation:
  - `requireAuth: boolean`
  - `requireFeatures: string[]`
  - `requireRoles: string[]`

## Handler signature

```ts
import type { ApiHandler } from '@open-mercato/shared/modules/api/types';

const handler: ApiHandler = async ({ request, container, organization, user }) => {
  const result = await container.resolve('inventoryService').list({ organizationId: organization.id });
  return Response.json({ items: result });
};

export const metadata = {
  requireAuth: true,
  requireFeatures: ['inventory_items.view'],
};

export default handler;
```

## Responses & errors

- Use `Response.json()` or helpers from `@open-mercato/shared/modules/api/responses` for consistent status codes.
- Throw `HttpError` from `@open-mercato/shared/modules/errors` to send typed errors.
- Log contextual information via the request logger: `container.resolve('logger').info({ ... }, 'message')`.

## Testing

- Import the handler and execute it with a mock container using Awilix’s `createContainer` in your Jest tests.
- Use the [API data fetching tutorial](../../tutorials/api-data-fetching) for an end-to-end walkthrough.

Most CRUD operations can rely on the [CRUD factory](./crud-factory), but understanding the routing layer ensures you can always drop down to custom implementations when necessary.

## Documentation

- Run `npm run modules:prepare` (or the wider build scripts) to refresh `modules.generated.ts`; the OpenAPI document is derived from this registry.
- The generated spec is exposed at:
  - `GET /api/docs/openapi` – OpenAPI 3.1 JSON (consumable by Swagger UI, Postman, etc.).
  - `GET /api/docs/markdown` – Markdown-flavoured documentation suited for quick sharing and LLM ingestion.
  - `/backend/api-docs` – Back-office page rendering the Markdown version for authenticated users with the `api_docs.view` feature.
- Each API route may export `openApi` metadata to enrich the spec. For file-based routes (`route.ts`), export an `openApi` object with Zod schemas describing query params, bodies, responses, and custom cURL examples:

```ts
import type { OpenApiRouteDoc } from '@open-mercato/shared/lib/openapi'
import { z } from 'zod'

export const openApi: OpenApiRouteDoc = {
  tag: 'Sales',
  methods: {
    POST: {
      summary: 'Create tax rate',
      requestBody: { schema: z.object({ name: z.string(), rate: z.number() }) },
      responses: [{ status: 201, schema: z.object({ id: z.string().uuid() }) }],
    },
  },
}
```

Leaving `openApi` undefined still emits an operation, but providing schemas unlocks typed examples, Markdown tables, and better client generation.

---
title: REST API Overview
description: How to authenticate, scope, and interact with the Open Mercato REST API.
---

The Open Mercato REST API is auto-discovered from each module under `src/modules/<module>/api`. Every handler is expressed as a standard Next.js `route.ts` module and is wrapped in shared infrastructure that enforces authentication, scoping, and feature checks. Use this page as the launch pad before diving into the detailed module guides.

## Base URL

- Local development: `http://localhost:3000/api`
- Production deployments: `<your-domain>/api`

All paths shown below are relative to the `/api` base.

## Quick Start Environment

```bash
export BASE_URL="http://localhost:3000/api"
export AUTH_TOKEN="<paste your JWT here>"
export ORG_ID="<optional active organization id>"
```

`AUTH_TOKEN` is returned by `POST /login`. Many `curl` examples reuse these environment variables so you can copy, tweak, and run them immediately.

## Authentication Flow

1. Call `POST /login` with form data (`email`, `password`, optional `remember`). A successful response returns a JSON payload with a signed JWT (`token`) and sets the `auth_token` HTTP-only cookie.
2. For API clients, read the `token` value and send it as `Authorization: Bearer <token>` on every request. Cookies are accepted as a fallback when the header is absent.
3. Tokens embed `sub` (user id), `tenantId`, `orgId`, `email`, and assigned role names. Requests lacking a valid token receive `401 Unauthorized`.

Sessions created with `remember` also emit a `session_token` cookie that can refresh web sessions but is not meant for API clients.

Learn more and explore endpoint walkthroughs in [Authentication & RBAC](./auth).

## Feature Gates & Access Control

Each HTTP method exports `metadata` declaring `requireAuth`, `requireRoles`, and `requireFeatures`. The RBAC service evaluates the metadata against the authenticated principal:

- Features are string identifiers (for example `auth.users.list`) exposed by every module under `src/modules/<module>/acl.ts`.
- Users receive features via roles or custom ACLs (`/api/auth/users/acl`). Super administrators bypass feature checks.
- If the caller lacks the declared feature(s), the API returns `403 Forbidden`.

## Tenant and Organization Scoping

- Tenants are encoded in the JWT (`tenantId`). Most entities require an active tenant; requests without one fail with `400` or `403`.
- Organization context defaults to the JWT `orgId`. Users can change it through the backend UI, which stores the selection in the `om_selected_org` cookie consumed by the API layer.
- When a module opts into organization scoping, create/update requests inject the active organization automatically; list requests are filtered to the allowed organizations resolved from RBAC + cookies.
- The `GET /directory/organization-switcher` endpoint returns the organization tree the current user may access. Clients can persist a new selection by setting the `om_selected_org` cookie before subsequent API calls.

Full examples live in the [Directory service guide](./directory).

## Request & Response Conventions

- **Payload format:** JSON bodies unless the handler specifies otherwise (only `/login` expects `multipart/form-data` or `application/x-www-form-urlencoded`).
- **Pagination:** List endpoints accept `page` (default `1`) and `pageSize` (default `50`, max `100` or `200` depending on the handler) and respond with `{ items, total, page, pageSize, totalPages }`.
- **Filtering:** Common filters include `search`, `id`, and module-specific filters such as `roleIds` or `tenantId`. Custom field filters use the `cf_<key>` convention and obey the custom field kind.
- **Sorting:** When powered by the Query Engine, endpoints accept `sortField` and `sortDir` (`asc` or `desc`).
- **Custom fields:** Include values under `customFields` or prefixed keys (`cf_priority`) in create/update payloads. The CRUD factory persists them automatically.
- **Concurrency:** Endpoints are stateless. Optimistic concurrency is handled at the application level.
- **Media types:** Set `Content-Type: application/json` for JSON bodies and `Accept: application/json` on reads to opt into JSON responses.

## Error Semantics & Status Codes

- **2xx** &mdash; Successful operations (`200 OK`, `201 Created`, `204 No Content`).
- **400** &mdash; Validation failures or malformed payloads (`{ "error": "Invalid input" }`).
- **401** &mdash; Missing or invalid credentials.
- **403** &mdash; Authenticated but missing required feature or tenant scope.
- **404** &mdash; Entity not found in the current tenant/organization scope.
- **409** &mdash; Business rule violations (for example deleting a role with assigned users).
- **5xx** &mdash; Unexpected server faults. Inspect server logs; messages are intentionally vague to avoid leaking internals.

## Tooling & Automation

- Use `npm run dev` to boot the stack locally; the API listens on port `3000`.
- `npm run modules:prepare` regenerates routing metadata after you add or remove module APIs.
- For integration tests, compose requests with `createRequestContainer()` to reuse the same dependency injection graph as production handlers.
- Use the shared CRUD helpers in `@open-mercato/shared/lib/crud/factory` to ensure consistent pagination, scoping, and event emission logic.

## Module Guides

- [Authentication & RBAC](./auth)
- [Directory Service](./directory)
- [Dashboards](./dashboards)
- [Entities & Custom Fields](./entities)

With these conventions in mind, hop into the module-specific pages for endpoint breakdowns, sample payloads, and extensive `curl` recipes you can adapt for your own tooling.

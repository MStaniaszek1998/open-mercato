---
title: REST API Overview
description: How to authenticate, scope, and interact with the Open Mercato REST API.
---

The Open Mercato REST API is auto-discovered from each module under `src/modules/<module>/api`. Every handler is expressed as a standard Next.js `route.ts` module and is wrapped in shared infrastructure that enforces authentication, scoping, and feature checks. This page explains how to consume those endpoints safely and lists the default endpoints that ship with the starter modules.

## Base URL

- Local development: `http://localhost:3000/api`
- Production deployments: `<your-domain>/api`

All paths shown below are relative to the `/api` base.

## Authentication

1. Call `POST /login` with form data (`email`, `password`, optional `remember`). A successful response returns a JSON payload with a signed JWT (`token`) and sets the `auth_token` HTTP-only cookie.
2. For API clients, read the `token` value and send it as `Authorization: Bearer <token>` on every request. Cookies are accepted as a fallback when the header is absent.
3. Tokens embed `sub` (user id), `tenantId`, `orgId`, `email`, and assigned role names. Requests lacking a valid token receive `401 Unauthorized`.

Sessions created with `remember` also emit a `session_token` cookie that can refresh web sessions but is not meant for API clients.

## Feature Gates & Access Control

Each HTTP method exports `metadata` declaring `requireAuth`, `requireRoles`, and `requireFeatures`. The RBAC service evaluates the metadata against the authenticated principal:

- Features are string identifiers (e.g. `auth.users.list`) exposed by every module under `src/modules/<module>/acl.ts`.
- Users receive features via roles or custom ACLs (`/api/users/acl`). Super administrators bypass feature checks.
- If the caller lacks the declared feature(s), the API returns `403 Forbidden`.

## Tenant and Organization Scoping

- Tenants are encoded in the JWT (`tenantId`). Most entities require an active tenant; requests without one will fail with `400` or `403`.
- Organization context defaults to the JWT `orgId`. Users can change it through the backend UI, which stores the selection in the `om_selected_org` cookie consumed by the API layer.
- When a module opt-in to organization scoping, create/update requests inject the active organization automatically; list requests are filtered to the allowed organizations resolved from RBAC + cookies.
- The `GET /directory/organization-switcher` endpoint returns the organization tree the current user may access. Clients can persist a new selection by setting the `om_selected_org` cookie before subsequent API calls.

## Request & Response Conventions

- **Payload format:** JSON bodies unless the handler specifies otherwise (only `/login` expects `multipart/form-data` or `application/x-www-form-urlencoded`).
- **Pagination:** List endpoints accept `page` (default `1`) and `pageSize` (default `50`, max `100` or `200` depending on the handler) and respond with `{ items, total, page, pageSize, totalPages }`.
- **Filtering:** Common filters include `search` (case-insensitive contains), `id`, and module-specific filters such as `roleIds` or `tenantId`. Custom field filters use the `cf_<key>` convention and obey the custom field kind.
- **Sorting:** When powered by the Query Engine, endpoints accept `sortField` and `sortDir` (`asc` or `desc`).
- **Custom fields:** Include values under `customFields` or prefixed keys (`cf_priority`) in create/update payloads. The CRUD factory persists them automatically.
- **Concurrency:** Endpoints are stateless. Optimistic concurrency is handled at the application level.
- **Errors:** Validation failures return HTTP `400 { error: 'Invalid input' }`. Access violations return `401` or `403`. Unexpected errors return `500 { error: 'Internal server error' }`. CRUD-related edge cases may surface module-specific messages (e.g. `Role has assigned users`).

## Module Endpoints

### Authentication (`auth`)

| Method | Path | Description | Required feature(s) |
| --- | --- | --- | --- |
| `POST` | `/login` | Issue JWT + cookies; expects `email`, `password`, optional `remember`, `requireRole`. | Public |
| `GET` | `/auth/users` | Paginated user list with search and role filters. Supports custom field projections. | `auth.users.list` |
| `POST` | `/auth/users` | Create user in current organization; accepts `roles` array and custom fields. | `auth.users.create` |
| `PUT` | `/auth/users` | Update user email, password, roles, and organization assignment. | `auth.users.edit` |
| `DELETE` | `/auth/users?id=UUID` | Hard-delete user. | `auth.users.delete` |
| `GET` | `/auth/users/acl?userId=UUID` | Fetch per-user ACL overrides for tenant. | `auth.acl.manage` |
| `PUT` | `/auth/users/acl` | Upsert ACL overrides (`isSuperAdmin`, `features`, `organizations`). | `auth.acl.manage` |
| `GET` | `/auth/roles` | Paginated role list with search. | `auth.roles.list` |
| `POST` | `/auth/roles` | Create role (tenant-scoped). | `auth.roles.manage` |
| `PUT` | `/auth/roles` | Update role name or tenant binding. | `auth.roles.manage` |
| `DELETE` | `/auth/roles?id=UUID` | Delete role (fails if users assigned). | `auth.roles.manage` |
| `GET` | `/auth/roles/acl?roleId=UUID` | Retrieve feature assignments for a role. | `auth.roles.manage` |
| `PUT` | `/auth/roles/acl` | Update feature assignments for a role. | `auth.roles.manage` |

### Directory (`directory`)

| Method | Path | Description | Required feature(s) |
| --- | --- | --- | --- |
| `GET` | `/directory/organization-switcher` | Returns accessible organization tree for the active tenant. | Authenticated user |
| `GET` | `/directory/organizations` | Paginated list / options / hierarchy depending on `view`. Filters by `tenantId`, status, `ids`. | `directory.organizations.view` |
| `POST` | `/directory/organizations` | Create organization; requires `name`, optional `parentId`; auto-scopes to tenant & selection. | `directory.organizations.manage` |
| `PUT` | `/directory/organizations` | Update organization metadata and hierarchy. | `directory.organizations.manage` |
| `DELETE` | `/directory/organizations?id=UUID` | Soft-delete organization (rebuilds hierarchy). | `directory.organizations.manage` |
| `GET` | `/directory/tenants` | List tenants for super admins or tenant-scoped admins. | `directory.tenants.view` |
| `POST` | `/directory/tenants` | Create tenant (name, slug, isActive). | `directory.tenants.manage` |
| `PUT` | `/directory/tenants` | Update tenant metadata. | `directory.tenants.manage` |
| `DELETE` | `/directory/tenants?id=UUID` | Soft-delete tenant. | `directory.tenants.manage` |

### Dashboard (`dashboards`)

| Method | Path | Description | Required feature(s) |
| --- | --- | --- | --- |
| `GET` | `/dashboards/layout` | Fetch current user's dashboard layout definition. | `dashboard.widgets.view` |
| `PUT` | `/dashboards/layout` | Replace dashboard layout; accepts widgets array. | `dashboard.widgets.manage` |
| `GET` | `/dashboards/layout/{itemId}` | Retrieve a single dashboard item configuration. | `dashboard.widgets.view` |
| `DELETE` | `/dashboards/layout/{itemId}` | Remove dashboard item. | `dashboard.widgets.manage` |
| `GET` | `/dashboards/roles/widgets` | Widgets available to a given role (query `roleId`). | `dashboard.widgets.view` |
| `GET` | `/dashboards/users/widgets` | Widgets assigned directly to a user (`userId`). | `dashboard.widgets.view` |

### Entities & Custom Fields (`entities`)

| Method | Path | Description | Required feature(s) |
| --- | --- | --- | --- |
| `GET` | `/entities` | List generated + custom entities available in scope. | Authenticated user |
| `POST` | `/entities` | Upsert module-scoped custom entity metadata. | `entities.definitions.manage` |
| `DELETE` | `/entities` | Soft-delete a custom entity definition. | `entities.definitions.manage` |
| `GET` | `/entities/definitions` | List active field definitions for a given `entityId`. | Authenticated user |
| `POST` | `/entities/definitions` | Upsert a single field definition. | `entities.definitions.manage` |
| `DELETE` | `/entities/definitions` | Soft-delete a field definition. | `entities.definitions.manage` |
| `GET` | `/entities/definitions/manage` | Management view (active + deleted definitions, tombstones). | `entities.definitions.manage` |
| `POST` | `/entities/definitions/batch` | Batch-upsert ordered field definitions. | `entities.definitions.manage` |
| `POST` | `/entities/definitions/restore` | Restore a tombstoned field definition. | `entities.definitions.manage` |
| `GET` | `/entities/records` | Paginated records for custom entities via Query Engine. | `entities.records.view` |
| `POST` | `/entities/records` | Create custom entity record. | `entities.records.manage` |
| `PUT` | `/entities/records` | Update custom entity record. | `entities.records.manage` |
| `DELETE` | `/entities/records?id=UUID` | Soft-delete custom entity record. | `entities.records.manage` |

> **Note:** Custom entity definition handlers live under `packages/core/src/modules/entities/api`. Generated modules may contribute additional endpoints; run `npm run modules:prepare` after adding modules to refresh routing metadata.

## Working with Generated Modules

- Generators aggregate route metadata in `src/modules/generated.ts`. Regenerate after adding or removing module APIs (`npm run modules:prepare`).
- When building custom modules, follow the module conventions (`api/<method>/<path>.ts`) to have endpoints auto-mounted under `/api/<path>`.
- Declare new feature flags in `src/modules/<module>/acl.ts` so access control remains auditable.

## Testing & Tooling

- CLI users can exercise APIs via `npm run dev` and any HTTP client (curl, Postman, Hoppscotch).
- For automated tests, leverage the shared Query Engine and DI container: construct requests with `createRequestContainer()` to reuse the same infrastructure used by API handlers.
- Use the `@open-mercato/shared/lib/crud/factory` utilities when authoring new CRUD endpoints to stay consistent with pagination, scoping, and error handling.

With these conventions, you can confidently extend the REST surface while preserving the modular isolation and multi-tenant guarantees provided by the Open Mercato framework.
